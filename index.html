<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Meu Treino</title>
  
  <!-- Configura√ß√µes PWA -->
  <meta name="apple-mobile-web-app-title" content="Meu Treino">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="apple-touch-icon" href="icon.png">

  <!-- Tailwind e Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

    /* Reset e Base */
    body {
      font-family: 'Inter', sans-serif;
      transition: background-color 0.3s, color 0.3s;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: none;
    }
    
    /* Temas */
    body[data-theme="light"] { background: #f8fafc; color: #1e293b; }
    body[data-theme="dark"] { background: #0f172a; color: #f8fafc; }

    /* Transi√ß√µes */
    .card, header, #settings-panel, .tab-btn, input, textarea {
      transition: all 0.3s ease;
    }

    /* Dark Mode Overrides */
    body[data-theme="dark"] .card { background: #1e293b; border-color: #334155; }
    body[data-theme="dark"] .tab-btn { color: #94a3b8; }
    body[data-theme="dark"] .tab-btn.active { background: #3b82f6; color: #fff; }
    body[data-theme="dark"] input, body[data-theme="dark"] textarea { background: #334155; border-color: #475569; color: #fff; }

    /* Modal e Utilit√°rios */
    #confirmation-modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      z-index: 1000; display: none; align-items: center; justify-content: center;
      backdrop-filter: blur(2px);
    }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .fallback-logo { display: none; }

    /* Anima√ß√£o Check */
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .check-btn.checked { animation: pop 0.2s ease-in-out; }

    /* Estilo do Editor JSON */
    .json-editor {
      font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
      font-size: 11px;
      line-height: 1.4;
      white-space: pre;
      overflow-x: auto;
    }
  </style>
</head>
<body data-theme="light" class="pb-safe">
  
  <!-- Cabe√ßalho Fixo -->
  <header class="bg-white/90 dark:bg-slate-900/90 backdrop-blur-md p-4 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between sticky top-0 z-30 shadow-sm h-[72px]">
    <div class="flex items-center gap-3">
      <!-- Logo -->
      <div class="relative w-10 h-10 shadow-lg rounded-xl overflow-hidden group">
        <img src="icon.png" alt="Logo" class="w-full h-full object-cover" onerror="this.style.display='none'; document.getElementById('fallback-logo').style.display='flex'">
        <div id="fallback-logo" class="fallback-logo w-full h-full absolute top-0 left-0 bg-gradient-to-br from-blue-600 to-indigo-600 items-center justify-center text-white font-bold text-xl select-none">T</div>
      </div>

      <div>
        <h1 id="header-title" class="text-lg font-extrabold text-blue-600 dark:text-blue-400 m-0 leading-tight">Treino</h1>
        <div class="text-xs text-slate-500 dark:text-slate-400 font-medium">Ol√°, <span id="show-user-name" class="text-slate-700 dark:text-slate-200">Atleta</span></div>
      </div>
    </div>
    
    <button class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center justify-center text-xl transition-all active:scale-90 shadow-sm border border-slate-200 dark:border-slate-700" onclick="toggleSettings()">
      ‚öôÔ∏è
    </button>
  </header>

  <!-- Painel de Configura√ß√µes -->
  <div id="settings-panel" class="fixed top-[80px] right-4 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-2xl p-5 w-80 hidden z-40 transform transition-all duration-300 origin-top-right overflow-y-auto max-h-[80vh]">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold text-slate-800 dark:text-white">Ajustes</h3>
      <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600">‚úï</button>
    </div>
    
    <!-- Nome -->
    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">Seu Perfil</label>
    <div class="flex gap-2 mb-5">
      <input id="edit-user-name" type="text" class="flex-1 p-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Seu nome">
      <button onclick="saveUserNameSettings()" class="bg-blue-600 text-white px-4 rounded-xl text-sm font-bold shadow-lg shadow-blue-500/20 active:scale-95 transition-transform">OK</button>
    </div>
    
    <!-- Tema -->
    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">Visual</label>
    <button onclick="toggleTheme()" class="flex items-center justify-between w-full p-3 rounded-xl bg-slate-100 dark:bg-slate-700/50 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors mb-5 border border-transparent dark:border-slate-600">
      <span id="theme-label" class="text-sm font-semibold text-slate-700 dark:text-slate-200">Modo Claro</span>
      <span id="theme-icon" class="text-lg">‚òÄÔ∏è</span>
    </button>

    <hr class="border-slate-100 dark:border-slate-700 my-4">

    <!-- √Årea de JSON -->
    <div class="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
      <label class="text-[10px] font-bold text-blue-500 uppercase tracking-widest mb-2 flex items-center justify-between">
        Importar Treino (JSON)
        <span class="bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded text-[9px]">IA</span>
      </label>
      <textarea id="json-input" class="json-editor w-full h-32 p-3 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-600 dark:text-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3 resize-none shadow-inner" placeholder='Cole o JSON aqui...'></textarea>
      
      <div class="grid grid-cols-2 gap-2">
        <button onclick="resetToDefault()" class="py-2.5 rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs font-bold hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
          Restaurar
        </button>
        <button onclick="importWorkoutJson()" class="py-2.5 rounded-lg bg-emerald-500 text-white text-xs font-bold shadow-lg shadow-emerald-500/20 hover:bg-emerald-600 active:scale-95 transition-all">
          Salvar Treino
        </button>
      </div>
    </div>
  </div>

  <!-- Navega√ß√£o (Tabs) -->
  <div class="sticky top-[72px] z-20 bg-white/95 dark:bg-slate-900/95 backdrop-blur-sm border-b border-slate-200 dark:border-slate-800 py-3 shadow-sm">
    <div class="flex overflow-x-auto px-4 gap-2 no-scrollbar" id="tabs-container">
      <!-- Tabs geradas via JS -->
    </div>
  </div>

  <!-- Conte√∫do Principal -->
  <main class="max-w-xl mx-auto px-4 py-6 mb-24 min-h-[60vh]" id="app-content">
    <!-- Cards dos exerc√≠cios entram aqui -->
  </main>

  <!-- Gr√°fico Fixo no final -->
  <section class="max-w-xl mx-auto px-4 pb-12">
    <div class="bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-sm border border-slate-100 dark:border-slate-700">
      <h2 class="text-sm font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-6 flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-blue-500"></span> Desempenho
      </h2>
      <div class="relative h-56 w-full">
        <canvas id="chart-semana"></canvas>
      </div>
      <div id="info-metricas" class="text-xs font-medium text-slate-400 mt-6 text-center bg-slate-50 dark:bg-slate-900 py-2 rounded-lg"></div>
    </div>
  </section>

  <!-- Modal Boas Vindas -->
  <div id="user-modal" class="hidden fixed inset-0 bg-slate-900/80 z-[60] items-center justify-center p-4 backdrop-blur-sm transition-opacity">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center transform transition-all scale-100">
      <div class="w-20 h-20 bg-gradient-to-tr from-blue-500 to-indigo-500 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/30">
        <span class="text-4xl">üí™</span>
      </div>
      <h2 class="text-2xl font-extrabold text-slate-800 dark:text-white mb-2">Vamos treinar!</h2>
      <p class="text-slate-500 dark:text-slate-400 mb-8 text-sm leading-relaxed">Para personalizar sua experi√™ncia, como voc√™ gostaria de ser chamado?</p>
      
      <input id="input-user-name" type="text" class="w-full p-4 rounded-2xl border-2 border-slate-100 dark:border-slate-700 mb-4 bg-slate-50 dark:bg-slate-900 text-center text-lg font-bold outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all" placeholder="Seu Nome">
      
      <button onclick="saveUserNameModal()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-2xl transition-all transform active:scale-95 shadow-xl shadow-blue-600/20">
        Come√ßar Agora
      </button>
    </div>
  </div>

  <!-- Modal Confirma√ß√£o Reset -->
  <div id="confirmation-modal">
    <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-2xl w-full max-w-xs text-center mx-4 border border-slate-100 dark:border-slate-700">
      <div class="w-14 h-14 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">üóëÔ∏è</div>
      <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-2">Reiniciar Semana?</h3>
      <p class="text-slate-500 dark:text-slate-400 text-sm mb-6 leading-relaxed">Todo o seu hist√≥rico de check-ins desta semana ser√° apagado.</p>
      <div class="flex gap-3">
        <button id="confirm-cancel" class="flex-1 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold text-sm hover:bg-slate-200 transition-colors">Cancelar</button>
        <button id="confirm-ok" class="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold text-sm shadow-lg shadow-red-500/30 hover:bg-red-600 transition-colors">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    // --- Configura√ß√£o Inicial ---
    tailwind.config = { darkMode: 'class', theme: { extend: { colors: { 'slate-850': '#1e293b' }, fontFamily: { sans: ['Inter', 'sans-serif'] } } } }

    // DADOS INICIAIS (Baseados na sua imagem original)
    const INITIAL_WORKOUT = {
      "Segunda": { 
        "focus": "Peito, Tr√≠ceps e Ombro", 
        "exercises": [
          { "id": "s1", "name": "Supino Inclinado", "sets": 4, "reps": "8-12" },
          { "id": "s2", "name": "Supino M√°quina", "sets": 4, "reps": "10-12" },
          { "id": "s3", "name": "Voador", "sets": 4, "reps": "12-15" },
          { "id": "s4", "name": "Crucifixo", "sets": 4, "reps": "12" },
          { "id": "s5", "name": "Tr√≠ceps Franc√™s", "sets": 2, "reps": "10-12" },
          { "id": "s6", "name": "Barra V", "sets": 2, "reps": "12" },
          { "id": "s7", "name": "Eleva√ß√£o Lateral Halter", "sets": 1, "reps": "15" }
        ]
      },
      "Ter√ßa": { 
        "focus": "Costas e B√≠ceps", 
        "exercises": [
          { "id": "t1", "name": "Puxada Alta Neutra", "sets": 4, "reps": "10-12" },
          { "id": "t2", "name": "Remada Baixa Tri√¢ngulo", "sets": 4, "reps": "10-12" },
          { "id": "t3", "name": "Remada Curvada", "sets": 4, "reps": "10" },
          { "id": "t4", "name": "Serrote", "sets": 4, "reps": "10" },
          { "id": "t5", "name": "Rosca Barra W", "sets": 2, "reps": "10-12" },
          { "id": "t6", "name": "Rosca Banco 45¬∫", "sets": 2, "reps": "12" }
        ]
      },
      "Quarta": { 
        "focus": "Perna Completa", 
        "exercises": [
          { "id": "q1", "name": "Agachamento", "sets": 4, "reps": "8-10" },
          { "id": "q2", "name": "Leg Press", "sets": 4, "reps": "10-12" },
          { "id": "q3", "name": "Cadeira Extensora", "sets": 4, "reps": "15" },
          { "id": "q4", "name": "Mesa Flexora", "sets": 4, "reps": "12-15" },
          { "id": "q5", "name": "Panturrilhas", "sets": 4, "reps": "15-20" }
        ]
      },
      "Quinta": { 
        "focus": "Ombro Completo", 
        "exercises": [
          { "id": "qi1", "name": "Desenv. M√°quina", "sets": 4, "reps": "8-10" },
          { "id": "qi2", "name": "Eleva√ß√£o Lateral", "sets": 4, "reps": "12-15" },
          { "id": "qi3", "name": "Eleva√ß√£o Frontal", "sets": 4, "reps": "12" },
          { "id": "qi4", "name": "Voador Invertido", "sets": 4, "reps": "12-15" },
          { "id": "qi5", "name": "Rosca Martelo", "sets": 2, "reps": "12" },
          { "id": "qi6", "name": "Rosca Scott", "sets": 2, "reps": "12" },
          { "id": "qi7", "name": "Tr√≠ceps Corda", "sets": 2, "reps": "12" },
          { "id": "qi8", "name": "Tr√≠ceps Testa", "sets": 2, "reps": "12" }
        ]
      }
    };

    const DB_STATE_KEY = "meutreino_v3_state";
    const DB_DATA_KEY = "meutreino_v3_data";

    // --- State Management ---
    let workoutData = JSON.parse(localStorage.getItem(DB_DATA_KEY)) || INITIAL_WORKOUT;
    let appState = JSON.parse(localStorage.getItem(DB_STATE_KEY)) || { theme: "light", userName: "", completed: {}, weights: {}, lastWeekReset: 0 };
    
    // Fallback se o JSON estiver vazio
    if(Object.keys(workoutData).length === 0) workoutData = INITIAL_WORKOUT;

    let currentDay = getAutoDay();
    let daysKeys = Object.keys(workoutData);

    // --- Core Functions ---
    function getWeekNumber(d = new Date()) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
      var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    function checkWeeklyReset() {
      const currentWeek = getWeekNumber();
      if(appState.lastWeekReset !== currentWeek) {
        appState.completed = {};
        appState.lastWeekReset = currentWeek;
        saveState();
      }
    }

    function saveState() { localStorage.setItem(DB_STATE_KEY, JSON.stringify(appState)); }
    function saveWorkoutData() { localStorage.setItem(DB_DATA_KEY, JSON.stringify(workoutData)); }

    function getAutoDay() {
      const map = ["Segunda", "Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"];
      const d = new Date().getDay();
      return workoutData[map[d]] ? map[d] : Object.keys(workoutData)[0];
    }

    // --- UI Rendering ---
    function renderAll() {
      // Tema
      const isDark = appState.theme === 'dark';
      document.body.setAttribute("data-theme", appState.theme);
      document.getElementById("theme-label").innerText = isDark ? "Modo Escuro" : "Modo Claro";
      document.getElementById("theme-icon").innerText = isDark ? "üåô" : "‚òÄÔ∏è";
      
      // Nome
      document.getElementById("show-user-name").innerText = appState.userName || "Atleta";
      document.getElementById("edit-user-name").value = appState.userName || "";

      // Dados Din√¢micos
      daysKeys = Object.keys(workoutData);
      
      // Valida dia atual
      if(!workoutData[currentDay] && currentDay !== 'Resumo') currentDay = daysKeys[0];

      renderTabs();
      renderDay(currentDay);
      renderChart();
    }

    function renderTabs() {
      const container = document.getElementById('tabs-container');
      container.innerHTML = '';
      
      const createBtn = (label, key) => {
        const btn = document.createElement('button');
        const isActive = currentDay === key;
        btn.onclick = () => { currentDay = key; renderAll(); };
        btn.innerText = label;
        btn.className = `tab-btn whitespace-nowrap px-5 py-2.5 rounded-full text-sm font-bold transition-all transform ${
          isActive 
          ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/40 scale-105' 
          : 'bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700'
        }`;
        container.appendChild(btn);
      };

      daysKeys.forEach(day => createBtn(day, day));
      createBtn("Resumo", "Resumo");
    }

    function renderDay(day) {
      const container = document.getElementById('app-content');
      container.innerHTML = '';

      if (day === 'Resumo') {
        document.getElementById('header-title').innerText = "Resumo Semanal";
        renderResumo(container);
        return;
      }

      const data = workoutData[day];
      document.getElementById('header-title').innerHTML = `${day} <span class="block text-xs font-normal text-slate-400 dark:text-slate-500 mt-0.5 truncate max-w-[200px]">${data.focus || 'Treino do dia'}</span>`;

      if (!data.exercises || data.exercises.length === 0) {
        container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-400"><span class="text-4xl mb-2">üí§</span><p>Descanso</p></div>`;
        return;
      }

      data.exercises.forEach(ex => {
        const isDone = appState.completed[ex.id];
        const weight = appState.weights[ex.id] || '';
        
        const card = document.createElement('div');
        // Mantendo o estilo visual original exato
        card.className = `card relative overflow-hidden bg-white dark:bg-slate-800 rounded-2xl p-5 mb-4 border-l-[6px] shadow-sm hover:shadow-md ${
          isDone ? 'border-l-emerald-500' : 'border-l-blue-500'
        } border-y border-r border-slate-100 dark:border-slate-700/50`;

        card.innerHTML = `
          <div class="flex justify-between items-start gap-4">
            <div class="flex-1">
              <h3 class="text-[17px] font-bold text-slate-800 dark:text-slate-100 leading-tight mb-2">${ex.name}</h3>
              <div class="flex flex-wrap gap-2 mb-3">
                <span class="bg-slate-100 dark:bg-slate-700/60 text-slate-600 dark:text-slate-300 px-2.5 py-1 rounded-lg text-xs font-bold uppercase tracking-wider">${ex.sets} s√©ries</span>
                <span class="bg-slate-100 dark:bg-slate-700/60 text-slate-600 dark:text-slate-300 px-2.5 py-1 rounded-lg text-xs font-bold uppercase tracking-wider">${ex.reps} reps</span>
              </div>
              
              <div class="flex items-center gap-3">
                <div class="bg-slate-50 dark:bg-slate-900 rounded-xl px-3 py-1.5 flex items-center border border-slate-200 dark:border-slate-700 transition-colors focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-500/20">
                  <input type="number" inputmode="numeric" 
                    class="w-10 text-center bg-transparent font-bold text-slate-700 dark:text-white outline-none text-lg" 
                    placeholder="-" value="${weight}" 
                    onchange="updateWeight('${ex.id}', this.value)"
                    onclick="this.select()">
                  <span class="text-xs text-slate-400 font-bold ml-1 uppercase">kg</span>
                </div>
              </div>
            </div>
            
            <button onclick="toggleCheck('${ex.id}')" 
              class="check-btn h-14 w-14 rounded-2xl flex items-center justify-center text-2xl transition-all shadow-sm active:scale-95 ${
              isDone 
              ? 'checked bg-emerald-500 text-white shadow-emerald-500/40' 
              : 'bg-slate-50 dark:bg-slate-700/50 text-slate-300 dark:text-slate-600 border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700'
            }">
              ${isDone ? '‚úì' : ''}
            </button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function renderResumo(container) {
      let total = 0, done = 0;
      daysKeys.forEach(d => {
        if(workoutData[d].exercises) {
          workoutData[d].exercises.forEach(ex => {
            total++;
            if(appState.completed[ex.id]) done++;
          });
        }
      });
      
      const pct = total === 0 ? 0 : Math.round((done/total)*100);

      container.innerHTML = `
        <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-8 mb-6 shadow-xl border border-slate-100 dark:border-slate-700 text-center relative overflow-hidden group">
          <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500"></div>
          
          <div class="relative z-10">
            <div class="text-7xl font-black text-slate-800 dark:text-white mb-2 tracking-tighter bg-clip-text text-transparent bg-gradient-to-br from-slate-800 to-slate-500 dark:from-white dark:to-slate-400">
              ${pct}%
            </div>
            <p class="text-slate-400 dark:text-slate-500 text-xs font-bold uppercase tracking-[0.2em] mb-8">Conclus√£o Semanal</p>
            
            <div class="inline-flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-900 rounded-full text-sm font-semibold text-slate-600 dark:text-slate-300">
              <span>üî•</span> ${done} / ${total} Exerc√≠cios
            </div>
          </div>
        </div>
        
        <button onclick="document.getElementById('confirmation-modal').style.display='flex'" class="w-full bg-red-50 hover:bg-red-100 dark:bg-red-900/10 dark:hover:bg-red-900/20 text-red-500 dark:text-red-400 font-bold py-4 rounded-2xl transition-all text-sm flex items-center justify-center gap-3 border border-red-100 dark:border-red-900/30">
          <span>üóëÔ∏è</span> Reiniciar Semana
        </button>
      `;
    }

    // --- Actions ---
    function toggleCheck(id) {
      if(appState.completed[id]) delete appState.completed[id];
      else appState.completed[id] = true;
      saveState();
      setTimeout(() => { renderAll(); }, 50); // Small delay for animation
    }

    function updateWeight(id, val) {
      appState.weights[id] = val;
      saveState();
    }

    function toggleTheme() {
      appState.theme = appState.theme === 'light' ? 'dark' : 'light';
      saveState();
      renderAll();
    }

    function toggleSettings() {
      const p = document.getElementById('settings-panel');
      if (p.classList.contains('hidden')) {
        p.classList.remove('hidden');
        setTimeout(() => p.classList.remove('opacity-0', 'scale-95'), 10);
      } else {
        p.classList.add('opacity-0', 'scale-95');
        setTimeout(() => p.classList.add('hidden'), 200);
      }
    }

    function saveUserNameSettings() {
      const name = document.getElementById('edit-user-name').value.trim();
      if(name) { appState.userName = name; saveState(); toggleSettings(); renderAll(); }
    }
    
    function saveUserNameModal() {
      const name = document.getElementById('input-user-name').value.trim();
      if(name) { appState.userName = name; saveState(); document.getElementById('user-modal').classList.add('hidden'); renderAll(); }
    }

    // --- JSON Logic ---
    function importWorkoutJson() {
      const input = document.getElementById('json-input').value;
      try {
        const parsed = JSON.parse(input);
        if(typeof parsed !== 'object' || Object.keys(parsed).length === 0) throw new Error();
        
        workoutData = parsed;
        saveWorkoutData();
        daysKeys = Object.keys(workoutData);
        currentDay = daysKeys[0];
        
        alert("Treino atualizado com sucesso!");
        toggleSettings();
        renderAll();
      } catch(e) {
        alert("Erro no JSON. Cole um c√≥digo v√°lido gerado pela IA.");
      }
    }

    function resetToDefault() {
      if(confirm("Voltar ao treino original?")) {
        workoutData = INITIAL_WORKOUT;
        saveWorkoutData();
        renderAll();
        toggleSettings();
      }
    }

    function resetWeek() {
      appState.completed = {};
      saveState();
      document.getElementById('confirmation-modal').style.display='none';
      renderAll();
    }

    document.getElementById('confirm-ok').onclick = resetWeek;
    document.getElementById('confirm-cancel').onclick = () => document.getElementById('confirmation-modal').style.display='none';

    // --- Chart ---
    let chartInstance = null;
    function renderChart() {
      const ctx = document.getElementById('chart-semana')?.getContext('2d');
      if(!ctx) return;

      const labels = Object.keys(workoutData);
      const dataPoints = labels.map(d => workoutData[d].exercises ? workoutData[d].exercises.filter(e => appState.completed[e.id]).length : 0);
      const shortLabels = labels.map(l => l.substring(0,3));

      const isDark = appState.theme === 'dark';
      
      if(chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: shortLabels,
          datasets: [{
            data: dataPoints,
            backgroundColor: isDark ? '#3b82f6' : '#2563eb',
            borderRadius: 8,
            barThickness: 20,
            maxBarThickness: 32
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { enabled: false } },
          scales: {
            y: { beginAtZero: true, grid: { color: isDark ? '#334155' : '#e2e8f0', drawBorder: false }, ticks: { color: isDark ? '#94a3b8' : '#64748b', font: {family: 'Inter', size: 10}, stepSize: 1 } },
            x: { grid: { display: false }, ticks: { color: isDark ? '#94a3b8' : '#64748b', font: {family: 'Inter', size: 11, weight: '600'} } }
          }
        }
      });
      
      const doneTotal = dataPoints.reduce((a,b)=>a+b,0);
      document.getElementById('info-metricas').innerHTML = doneTotal > 0 
        ? `üî• <b>${doneTotal}</b> exerc√≠cios conclu√≠dos esta semana`
        : "Seus dados aparecer√£o aqui";
    }

    // --- Init ---
    window.onload = function() {
      checkWeeklyReset();
      if(!appState.userName) document.getElementById('user-modal').classList.remove('hidden');
      else document.getElementById('user-modal').classList.add('hidden');
      renderAll();
    };
  </script>
</body>
</html>


