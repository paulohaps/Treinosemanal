<!DOCTYPE html>
<html lang="pt-BR" class="antialiased">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Meu Treino</title>
  
  <!-- Carrega configura√ß√µes de API externas -->
  <script src="api_config.js"></script>

  <!-- Configura√ß√µes PWA -->
  <meta name="apple-mobile-web-app-title" content="Meu Treino">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="apple-touch-icon" href="icon.png">

  <!-- Tailwind e Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Configura√ß√£o do Tailwind
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            slate: {
              850: '#1e293b',
              950: '#020617',
            }
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      transition: background-color 0.3s ease, color 0.3s ease;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: none;
    }

    .transition-theme {
      transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, fill 0.3s ease, stroke 0.3s ease;
    }

    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      z-index: 1000; display: none; align-items: center; justify-content: center;
      backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s ease;
    }
    .modal-overlay.show { display: flex; opacity: 1; }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .fallback-logo { display: none; }

    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .check-btn.checked { animation: pop 0.2s ease-in-out; }

    .toast {
      transform: translateY(-20px); opacity: 0; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 3px solid white;
      width: 20px;
      height: 20px;
      -webkit-animation: spin 1s linear infinite;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-950 text-slate-800 dark:text-slate-100 pb-safe transition-theme">

  <!-- Container de Notifica√ß√µes -->
  <div id="toast-container" class="fixed top-4 left-0 right-0 z-[100] flex flex-col items-center gap-2 pointer-events-none px-4"></div>
  
  <!-- Cabe√ßalho -->
  <header class="bg-white/90 dark:bg-slate-900/90 backdrop-blur-md p-4 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between sticky top-0 z-30 shadow-sm h-[72px] transition-theme">
    <div class="flex items-center gap-3">
      <div class="relative w-10 h-10 shadow-lg rounded-xl overflow-hidden group">
        <img src="icon.png" alt="Logo" class="w-full h-full object-cover" onerror="this.style.display='none'; document.getElementById('fallback-logo').style.display='flex'">
        <div id="fallback-logo" class="fallback-logo w-full h-full absolute top-0 left-0 bg-gradient-to-br from-blue-600 to-indigo-600 items-center justify-center text-white font-bold text-xl select-none">T</div>
      </div>
      <div>
        <h1 id="header-title" class="text-lg font-extrabold text-blue-600 dark:text-blue-400 m-0 leading-tight transition-theme">Treino</h1>
        <div class="text-xs text-slate-500 dark:text-slate-400 font-medium transition-theme">Ol√°, <span id="show-user-name" class="text-slate-700 dark:text-slate-200">Atleta</span></div>
      </div>
    </div>
    
    <button id="btn-settings" aria-label="Abrir Configura√ß√µes" class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-xl transition-all active:scale-90 shadow-sm border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300">
      ‚öôÔ∏è
    </button>
  </header>

  <!-- Painel de Configura√ß√µes -->
  <div id="settings-panel" class="fixed top-[80px] right-4 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl shadow-2xl p-5 w-80 hidden z-40 transform transition-all duration-300 origin-top-right overflow-y-auto max-h-[80vh]">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold text-slate-800 dark:text-white">Ajustes</h3>
      <button id="btn-close-settings" aria-label="Fechar Configura√ß√µes" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 px-2 text-xl">‚úï</button>
    </div>
    
    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">Seu Perfil</label>
    <div class="flex gap-2 mb-5">
      <input id="edit-user-name" type="text" class="flex-1 p-2.5 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-white text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 transition-theme" placeholder="Seu nome">
      <button id="btn-save-name-settings" class="bg-blue-600 text-white px-4 rounded-xl text-sm font-bold shadow-lg shadow-blue-500/20 active:scale-95 transition-transform">OK</button>
    </div>
    
    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">Visual</label>
    <button id="btn-toggle-theme" class="flex items-center justify-between w-full p-3 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors mb-5 border border-transparent dark:border-slate-700 group">
      <span id="theme-label" class="text-sm font-semibold text-slate-700 dark:text-slate-200 transition-theme">Modo Claro</span>
      <span id="theme-icon" class="text-lg group-hover:scale-110 transition-transform">‚òÄÔ∏è</span>
    </button>

    <hr class="border-slate-100 dark:border-slate-800 my-4 transition-theme">

    <div class="bg-slate-50 dark:bg-slate-950/50 p-3 rounded-xl border border-slate-100 dark:border-slate-800 transition-theme">
      <label class="text-[10px] font-bold text-blue-500 uppercase tracking-widest mb-2 flex items-center justify-between">
        Gerenciar Treino
        <span class="bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded text-[9px] font-bold">GEMINI AI ‚ú®</span>
      </label>
      
      <button id="btn-open-ai-modal" class="w-full mb-3 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-xs font-bold shadow-lg shadow-blue-500/20 hover:shadow-blue-500/40 active:scale-95 transition-all flex items-center justify-center gap-2">
        <span>‚ú®</span> Criar Novo Treino
      </button>

      <p class="text-[10px] text-center text-slate-400 mb-2">- OU -</p>

      <div class="grid grid-cols-2 gap-2">
        <button id="btn-reset-default" class="py-2.5 rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs font-bold hover:bg-slate-300 dark:hover:bg-slate-700 transition-colors">
          Restaurar Padr√£o
        </button>
        <button id="btn-toggle-json-area" class="py-2.5 rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs font-bold hover:bg-slate-300 dark:hover:bg-slate-700 transition-colors">
          Editar JSON
        </button>
      </div>

      <div id="json-area-container" class="hidden mt-3">
        <textarea id="json-input" class="w-full h-32 p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-600 dark:text-slate-300 font-mono text-[11px] focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2 resize-none shadow-inner transition-theme" placeholder='Cole o JSON aqui...'></textarea>
        <button id="btn-import-json" class="w-full py-2 rounded-lg bg-emerald-500 text-white text-xs font-bold shadow-lg shadow-emerald-500/20 hover:bg-emerald-600 active:scale-95 transition-all">
          Salvar JSON Manual
        </button>
      </div>
    </div>
  </div>

  <!-- Navega√ß√£o -->
  <div class="sticky top-[72px] z-20 bg-white/95 dark:bg-slate-900/95 backdrop-blur-sm border-b border-slate-200 dark:border-slate-800 py-3 shadow-sm transition-theme">
    <div id="tabs-container" class="flex overflow-x-auto px-4 gap-2 no-scrollbar"></div>
  </div>

  <!-- Conte√∫do Principal -->
  <main id="app-content" class="max-w-xl mx-auto px-4 py-6 mb-24 min-h-[60vh]"></main>

  <!-- Gr√°fico -->
  <section class="max-w-xl mx-auto px-4 pb-12">
    <div class="bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-sm border border-slate-100 dark:border-slate-800 transition-theme">
      <h2 class="text-sm font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-6 flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-blue-500"></span> Desempenho
      </h2>
      <div class="relative h-56 w-full">
        <canvas id="chart-semana"></canvas>
      </div>
      <div id="info-metricas" class="text-xs font-medium text-slate-400 mt-6 text-center bg-slate-50 dark:bg-slate-900 py-2 rounded-lg transition-theme"></div>
    </div>
  </section>

  <!-- === MODALS === -->

  <!-- Modal IA Generator -->
  <div id="ai-generator-modal" class="modal-overlay z-[70]">
    <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl shadow-2xl w-full max-w-sm mx-4 border border-slate-100 dark:border-slate-800 relative">
      <button id="btn-close-ai" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">‚úï</button>
      
      <div class="text-center mb-6">
        <div class="w-14 h-14 bg-gradient-to-tr from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/20">
          <span class="text-2xl">‚ú®</span>
        </div>
        <h3 class="text-xl font-bold text-slate-800 dark:text-white">Criar Treino com Gemini</h3>
        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Descreva o seu objetivo e a IA cria o plano.</p>
      </div>

      <textarea id="ai-prompt-input" class="w-full h-24 p-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4 resize-none transition-theme" placeholder="Ex: Quero um treino de 4 dias focado em hipertrofia..."></textarea>
      
      <button id="btn-generate-workout" class="w-full py-3.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold text-sm shadow-xl shadow-blue-600/20 transition-all flex items-center justify-center gap-2">
        <span id="ai-btn-text">Gerar Treino</span>
      </button>
    </div>
  </div>

  <!-- Modal Dica IA -->
  <div id="ai-tip-modal" class="modal-overlay z-[70]">
    <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl shadow-2xl w-full max-w-sm mx-4 border border-slate-100 dark:border-slate-800 relative">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 rounded-full flex items-center justify-center text-xl">üí°</div>
        <h3 id="tip-title" class="text-lg font-bold text-slate-800 dark:text-white">Dica do Coach</h3>
      </div>
      <div id="tip-content" class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed mb-6 min-h-[60px]">Carregando dica inteligente...</div>
      <button id="btn-close-tip" class="w-full py-3 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 font-bold text-sm hover:bg-slate-200 transition-colors">Entendido</button>
    </div>
  </div>

  <!-- Modal Boas Vindas -->
  <div id="user-modal" class="modal-overlay z-[60]">
    <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center transform transition-all scale-100 mx-4 border border-slate-100 dark:border-slate-800">
      <div class="w-20 h-20 bg-gradient-to-tr from-blue-500 to-indigo-500 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/30">
        <span class="text-4xl">üí™</span>
      </div>
      <h2 class="text-2xl font-extrabold text-slate-800 dark:text-white mb-2">Vamos treinar!</h2>
      <p class="text-slate-500 dark:text-slate-400 mb-8 text-sm leading-relaxed">Para personalizar sua experi√™ncia, como voc√™ gostaria de ser chamado?</p>
      <input id="input-user-name-modal" type="text" class="w-full p-4 rounded-2xl border-2 border-slate-100 dark:border-slate-700 mb-4 bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-white text-center text-lg font-bold outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all" placeholder="Seu Nome">
      <button id="btn-start-modal" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-2xl transition-all transform active:scale-95 shadow-xl shadow-blue-600/20">Come√ßar Agora</button>
    </div>
  </div>

  <!-- Modal Confirma√ß√£o -->
  <div id="confirmation-modal" class="modal-overlay">
    <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl shadow-2xl w-full max-w-xs text-center mx-4 border border-slate-100 dark:border-slate-800">
      <div class="w-14 h-14 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">üóëÔ∏è</div>
      <h3 id="modal-title" class="text-lg font-bold text-slate-800 dark:text-white mb-2">Reiniciar Semana?</h3>
      <p id="modal-desc" class="text-slate-500 dark:text-slate-400 text-sm mb-6 leading-relaxed">Todo o seu hist√≥rico ser√° apagado.</p>
      <div class="flex gap-3">
        <button id="btn-modal-cancel" class="flex-1 py-3 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold text-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Cancelar</button>
        <button id="btn-modal-confirm" class="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold text-sm shadow-lg shadow-red-500/30 hover:bg-red-600 transition-colors">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    /* =================================================================
       1. CONFIGURA√á√ÉO E CONSTANTES
    ================================================================= */
    
    /* 1.1 Chaves de API e Configura√ß√£o Externa */
    const API_KEYS = window.API_CONFIG || { gemini: "" };

    /* 1.2 Constantes do Sistema */
    const CONFIG = {
      DB_STATE: "meutreino_v6_state",
      DB_DATA: "meutreino_v6_data",
      THEME_COLORS: {
        dark: { bar: '#3b82f6', grid: '#334155', text: '#94a3b8' },
        light: { bar: '#2563eb', grid: '#e2e8f0', text: '#64748b' }
      }
    };

    /* 1.3 Dados Padr√£o (Fallback) */
    const DEFAULT_WORKOUT_JSON = {
      "Segunda": {
        "focus": "Peito, Tr√≠ceps e Ombro (Lateral)",
        "exercises": [
          { "id": "seg1", "name": "Supino Inclinado", "sets": 4, "reps": "12" },
          { "id": "seg2", "name": "Supino M√°quina", "sets": 4, "reps": "12" },
          { "id": "seg3", "name": "Voador", "sets": 4, "reps": "12" },
          { "id": "seg4", "name": "Crucifixo", "sets": 4, "reps": "12" },
          { "id": "seg5", "name": "Franc√™s", "sets": 4, "reps": "12" },
          { "id": "seg6", "name": "Barra V (Tr√≠ceps)", "sets": 4, "reps": "12" },
          { "id": "seg7", "name": "Eleva√ß√£o Lateral com Halteres", "sets": 4, "reps": "12" }
        ]
      },
      "Ter√ßa": {
        "focus": "Costas e B√≠ceps",
        "exercises": [
          { "id": "ter1", "name": "Puxada Alta Neutra", "sets": 4, "reps": "12" },
          { "id": "ter2", "name": "Remada Baixa Tri√¢ngulo", "sets": 4, "reps": "12" },
          { "id": "ter3", "name": "Remada Curvada", "sets": 4, "reps": "12" },
          { "id": "ter4", "name": "Serrote (Remada Unilateral)", "sets": 4, "reps": "12" },
          { "id": "ter5", "name": "Rosca Barra W", "sets": 4, "reps": "12" },
          { "id": "ter6", "name": "Rosca Banco 45¬∞", "sets": 4, "reps": "12" }
        ]
      },
      "Quarta": {
        "focus": "Perna Completa",
        "exercises": [
          { "id": "qua1", "name": "Agachamento", "sets": 4, "reps": "12" },
          { "id": "qua2", "name": "Leg Press", "sets": 4, "reps": "12" },
          { "id": "qua3", "name": "Cadeira Extensora", "sets": 4, "reps": "12" },
          { "id": "qua4", "name": "Mesa Flexora", "sets": 4, "reps": "12" },
          { "id": "qua5", "name": "Panturrilhas (G√™meos)", "sets": 4, "reps": "15-20" }
        ]
      },
      "Quinta": {
        "focus": "Ombro Completo, B√≠ceps e Tr√≠ceps",
        "exercises": [
          { "id": "qui1", "name": "Desenvolvimento M√°quina", "sets": 4, "reps": "12" },
          { "id": "qui2", "name": "Eleva√ß√£o Lateral", "sets": 4, "reps": "12" },
          { "id": "qui3", "name": "Eleva√ß√£o Frontal", "sets": 4, "reps": "12" },
          { "id": "qui4", "name": "Voador Invertido", "sets": 4, "reps": "12" },
          { "id": "qui5", "name": "Rosca Martelo", "sets": 4, "reps": "12" },
          { "id": "qui6", "name": "Rosca Scot", "sets": 4, "reps": "12" },
          { "id": "qui7", "name": "Tr√≠ceps Corda", "sets": 4, "reps": "12" },
          { "id": "qui8", "name": "Tr√≠ceps Testa", "sets": 4, "reps": "12" }
        ]
      }
    };

    /* =================================================================
       2. SERVI√áOS NUCLEARES (CORE SERVICES)
    ================================================================= */
    
   /* 2.1 Servi√ßo de Intelig√™ncia Artificial (Apenas Gemini) */
    const AIService = {
      getProvider() {
        return 'gemini';
      },

      getKey() {
        return API_KEYS.gemini || '';
      },

      async call(prompt, systemContext = "") {
        // ... (Mantenha a fun√ß√£o call como est√°) ...
      },

      // üîΩ COLE O C√ìDIGO NOVO AQUI, SUBSTITUINDO A FUN√á√ÉO ANTIGA üîΩ
      async generateWorkout(userGoal) {
        // Prompt refor√ßado para garantir a estrutura exata
        const systemPrompt = `
          Atue como um personal trainer especialista.
          Crie um plano de treino baseado no pedido: "${userGoal}".
          
          REGRAS OBRIGAT√ìRIAS DE SA√çDA:
          1. Retorne APENAS o c√≥digo JSON cru.
          2. N√ÉO use blocos de c√≥digo markdown (sem \`\`\`json).
          3. N√ÉO escreva nenhuma introdu√ß√£o ou conclus√£o.
          4. Siga estritamente esta estrutura de chaves:
          {
            "Segunda": {
              "focus": "Descri√ß√£o do Foco",
              "exercises": [
                { "id": "s1", "name": "Supino", "sets": 4, "reps": "10" }
              ]
            },
            "Ter√ßa": { ... }
          }
          5. Use Portugu√™s. Garanta que cada exerc√≠cio tenha 'id', 'name', 'sets' e 'reps'.
        `;
        
        try {
          // Chama a fun√ß√£o call passando o systemPrompt como instru√ß√£o
          const result = await this.call(systemPrompt); 
          
          // 1. Remove formata√ß√£o Markdown comum
          let cleanJson = result.replace(/```json/g, '').replace(/```/g, '');
          
          // 2. Extra√ß√£o Cir√∫rgica: Pega tudo entre a primeira '{' e a √∫ltima '}'
          const firstBrace = cleanJson.indexOf('{');
          const lastBrace = cleanJson.lastIndexOf('}');
          
          if (firstBrace !== -1 && lastBrace !== -1) {
            cleanJson = cleanJson.substring(firstBrace, lastBrace + 1);
          }
          
          // 3. Tenta converter
          return JSON.parse(cleanJson);
          
        } catch (e) {
          console.error("Erro no parse da IA:", e);
          console.log("Texto recebido:", result); // Ajuda no debug
          throw new Error("Formato de treino incompat√≠vel. Tente novamente.");
        }
      },
      // üîº FIM DO C√ìDIGO NOVO üîº

      async getExerciseTip(exerciseName) {
         // ... (Mantenha a fun√ß√£o getExerciseTip como est√°) ...
      }
    };
    
    /* 2.2 Utilit√°rios e Helpers */
    const Utils = {
      getWeekNumber: (d = new Date()) => {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      },
      
      validateWorkoutJSON: (json) => {
        if (typeof json !== 'object' || json === null) return false;
        const days = Object.keys(json);
        if (days.length === 0) return false;
        return days.every(day => {
          const d = json[day];
          if (!d.hasOwnProperty('focus') || !Array.isArray(d.exercises)) return false;
          return d.exercises.every(ex => ex.id && ex.name && ex.sets && ex.reps);
        });
      }
    };

    /* =================================================================
       3. GERENCIAMENTO DE ESTADO (STATE)
    ================================================================= */
    
    /* 3.1 Defini√ß√£o e Inicializa√ß√£o do Estado */
    const State = {
      app: { theme: "light", userName: "", completed: {}, weights: {}, lastWeekReset: 0 },
      workout: {},
      currentDay: "",
      daysKeys: [],
      chartInstance: null,
      pendingModalAction: null,

      init() {
        this.app = JSON.parse(localStorage.getItem(CONFIG.DB_STATE)) || this.app;
        this.workout = JSON.parse(localStorage.getItem(CONFIG.DB_DATA)) || DEFAULT_WORKOUT_JSON;
        
        if (Object.keys(this.workout).length === 0) this.workout = DEFAULT_WORKOUT_JSON;
        
        this.checkWeeklyReset();
        this.updateDaysKeys();
        this.determineCurrentDay();
      },

      checkWeeklyReset() {
        const currentWeek = Utils.getWeekNumber();
        if (this.app.lastWeekReset !== currentWeek) {
          this.app.completed = {};
          this.app.lastWeekReset = currentWeek;
          this.saveApp();
        }
      },

      updateDaysKeys() {
        this.daysKeys = Object.keys(this.workout);
      },

      determineCurrentDay() {
        const map = ["Segunda", "Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"];
        const d = new Date().getDay();
        const autoDay = map[d];
        this.currentDay = this.workout[autoDay] ? autoDay : this.daysKeys[0];
      },

      saveApp() { localStorage.setItem(CONFIG.DB_STATE, JSON.stringify(this.app)); },
      saveWorkout() { localStorage.setItem(CONFIG.DB_DATA, JSON.stringify(this.workout)); },

      toggleCheck(id) {
        if (this.app.completed[id]) delete this.app.completed[id];
        else this.app.completed[id] = true;
        this.saveApp();
      },

      updateWeight(id, val) {
        this.app.weights[id] = val;
        this.saveApp();
      }
    };

    /* =================================================================
       4. INTERFACE DO USU√ÅRIO (UI MANAGER)
    ================================================================= */
    
    /* 4.1 Cache do DOM */
    const DOM = {};
    
    function cacheDOM() {
      const ids = [
        'header-title', 'show-user-name', 'btn-settings', 'settings-panel', 
        'btn-close-settings', 'edit-user-name', 'btn-save-name-settings',
        'btn-toggle-theme', 'theme-label', 'theme-icon', 'json-input', 
        'btn-reset-default', 'btn-import-json', 'tabs-container', 'app-content',
        'chart-semana', 'info-metricas', 'user-modal', 'input-user-name-modal',
        'btn-start-modal', 'confirmation-modal', 'modal-title', 'modal-desc',
        'btn-modal-cancel', 'btn-modal-confirm', 'toast-container',
        'btn-toggle-json-area', 'json-area-container',
        'ai-generator-modal', 'btn-open-ai-modal', 'btn-close-ai', 'ai-prompt-input', 'btn-generate-workout', 'ai-btn-text',
        'ai-tip-modal', 'tip-title', 'tip-content', 'btn-close-tip'
      ];
      ids.forEach(id => DOM[id] = document.getElementById(id));
    }

    /* 4.2 Gerenciador de UI */
    const UI = {
      showToast(message, type = 'success') {
        const el = document.createElement('div');
        const bg = type === 'success' ? 'bg-emerald-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500');
        el.className = `toast pointer-events-auto px-4 py-3 rounded-xl shadow-lg shadow-slate-400/20 text-white text-sm font-bold flex items-center gap-2 ${bg}`;
        el.innerHTML = `<span>${type === 'success' ? '‚úÖ' : (type === 'error' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è')}</span> ${message}`;
        DOM['toast-container'].appendChild(el);
        requestAnimationFrame(() => el.classList.add('show'));
        setTimeout(() => {
          el.classList.remove('show');
          setTimeout(() => el.remove(), 3000);
        }, 3000);
      },

      showModal(title, desc, onConfirm) {
        DOM['modal-title'].innerText = title;
        DOM['modal-desc'].innerText = desc;
        State.pendingModalAction = onConfirm;
        DOM['confirmation-modal'].classList.add('show');
      },

      closeModal() {
        DOM['confirmation-modal'].classList.remove('show');
        State.pendingModalAction = null;
      },

      toggleSettings(forceClose = false) {
        const p = DOM['settings-panel'];
        const isHidden = p.classList.contains('hidden');
        if (forceClose || !isHidden) {
          p.classList.add('opacity-0', 'scale-95');
          setTimeout(() => p.classList.add('hidden'), 200);
        } else {
          p.classList.remove('hidden');
          requestAnimationFrame(() => p.classList.remove('opacity-0', 'scale-95'));
        }
      },

      // --- AI UI Functions ---
      openAiModal() {
        UI.toggleSettings(true); 
        DOM['ai-generator-modal'].classList.add('show');
        DOM['ai-prompt-input'].value = '';
        DOM['ai-prompt-input'].focus();
      },

      async handleGenerateWorkout() {
        const prompt = DOM['ai-prompt-input'].value.trim();
        if(!prompt) return UI.showToast("Descreva o objetivo do treino.", "error");

        const btn = DOM['btn-generate-workout'];
        const btnText = DOM['ai-btn-text'];
        
        btn.disabled = true;
        const originalText = btnText.innerText;
        btnText.innerHTML = '<div class="spinner"></div>';
        
        try {
          const newWorkout = await AIService.generateWorkout(prompt);
          
          if(!Utils.validateWorkoutJSON(newWorkout)) throw new Error("IA gerou formato inv√°lido.");
          
          State.workout = newWorkout;
          State.saveWorkout();
          State.init();
          
          DOM['ai-generator-modal'].classList.remove('show');
          UI.renderAll();
          UI.showToast("Treino gerado com sucesso! ‚ú®");
        } catch (e) {
          UI.showToast("Erro: " + e.message, "error");
          console.error(e);
        } finally {
          btn.disabled = false;
          btnText.innerText = originalText;
        }
      },

      async openTipModal(exerciseName, btnElement) {
        DOM['tip-title'].innerText = exerciseName;
        DOM['tip-content'].innerHTML = '<div class="flex justify-center p-4"><div class="spinner border-slate-400 border-t-blue-500"></div></div>';
        DOM['ai-tip-modal'].classList.add('show');
        
        try {
          const tip = await AIService.getExerciseTip(exerciseName);
          const formattedTip = tip.replace(/\n/g, '<br>');
          DOM['tip-content'].innerHTML = formattedTip;
        } catch(e) {
          DOM['tip-content'].innerText = "Erro ao carregar dica: " + e.message;
        }
      },

      renderAll() {
        this.applyTheme();
        this.renderUser();
        this.renderTabs();
        this.renderContent();
        this.renderChart();
      },

      applyTheme() {
        const isDark = State.app.theme === 'dark';
        document.documentElement.classList.toggle('dark', isDark);
        DOM['theme-label'].innerText = isDark ? "Modo Escuro" : "Modo Claro";
        DOM['theme-icon'].innerText = isDark ? "üåô" : "‚òÄÔ∏è";
      },

      renderUser() {
        const name = State.app.userName || "Atleta";
        DOM['show-user-name'].innerText = name;
        DOM['edit-user-name'].value = State.app.userName || "";
      },

      renderTabs() {
        const container = DOM['tabs-container'];
        container.innerHTML = '';
        
        const createBtn = (label, key) => {
          const btn = document.createElement('button');
          const isActive = State.currentDay === key;
          btn.className = `whitespace-nowrap px-5 py-2.5 rounded-full text-sm font-bold transition-all transform ${
            isActive 
            ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/40 scale-105' 
            : 'bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700'
          }`;
          btn.innerText = label;
          btn.addEventListener('click', () => {
            State.currentDay = key;
            this.renderAll();
          });
          container.appendChild(btn);
        };

        State.daysKeys.forEach(day => createBtn(day, day));
        createBtn("Resumo", "Resumo");
      },

      renderContent() {
        const container = DOM['app-content'];
        container.innerHTML = '';

        if (State.currentDay === 'Resumo') {
          DOM['header-title'].innerText = "Resumo Semanal";
          this.renderResumoStats(container);
          return;
        }

        const data = State.workout[State.currentDay];
        DOM['header-title'].innerHTML = `${State.currentDay} <span class="block text-xs font-normal text-slate-400 dark:text-slate-500 mt-0.5 truncate max-w-[200px]">${data.focus || 'Treino do dia'}</span>`;

        if (!data.exercises || data.exercises.length === 0) {
          container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-400"><span class="text-4xl mb-2">üí§</span><p>Descanso</p></div>`;
          return;
        }

        data.exercises.forEach(ex => {
          const isDone = State.app.completed[ex.id];
          const weight = State.app.weights[ex.id] || '';
          
          const card = document.createElement('div');
          card.className = `card relative overflow-hidden bg-white dark:bg-slate-800 rounded-2xl p-5 mb-4 border-l-[6px] shadow-sm hover:shadow-md transition-theme ${
            isDone ? 'border-l-emerald-500' : 'border-l-blue-500'
          } border-y border-r border-slate-100 dark:border-slate-800`;
          
          card.innerHTML = `
            <div class="flex justify-between items-start gap-4">
              <div class="flex-1">
                <div class="flex items-start justify-between">
                  <h3 class="text-[17px] font-bold text-slate-800 dark:text-slate-100 leading-tight mb-2 transition-theme">${ex.name}</h3>
                  <button class="btn-tip bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 w-8 h-8 rounded-full flex items-center justify-center text-sm hover:scale-110 transition-transform" data-name="${ex.name}" aria-label="Dica IA">üí°</button>
                </div>
                <div class="flex flex-wrap gap-2 mb-3">
                  <span class="bg-slate-100 dark:bg-slate-700/60 text-slate-600 dark:text-slate-300 px-2.5 py-1 rounded-lg text-xs font-bold uppercase tracking-wider transition-theme">${ex.sets} s√©ries</span>
                  <span class="bg-slate-100 dark:bg-slate-700/60 text-slate-600 dark:text-slate-300 px-2.5 py-1 rounded-lg text-xs font-bold uppercase tracking-wider transition-theme">${ex.reps} reps</span>
                </div>
                
                <div class="flex items-center gap-3">
                  <div class="bg-slate-50 dark:bg-slate-900 rounded-xl px-3 py-1.5 flex items-center border border-slate-200 dark:border-slate-700 focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-500/20 transition-theme">
                    <input type="number" inputmode="numeric" 
                      class="weight-input w-10 text-center bg-transparent font-bold text-slate-700 dark:text-white outline-none text-lg" 
                      placeholder="-" value="${weight}" 
                      data-id="${ex.id}">
                    <span class="text-xs text-slate-400 font-bold ml-1 uppercase">kg</span>
                  </div>
                </div>
              </div>
              
              <button class="check-btn h-14 w-14 rounded-2xl flex items-center justify-center text-2xl transition-all shadow-sm active:scale-95 ${
                isDone 
                ? 'checked bg-emerald-500 text-white shadow-emerald-500/40' 
                : 'bg-slate-50 dark:bg-slate-700/50 text-slate-300 dark:text-slate-600 border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600'
              }" aria-label="Marcar como feito" data-id="${ex.id}">
                ${isDone ? '‚úì' : ''}
              </button>
            </div>
          `;
          container.appendChild(card);
        });
      },

      renderResumoStats(container) {
        let total = 0, done = 0;
        State.daysKeys.forEach(d => {
          if(State.workout[d].exercises) {
            State.workout[d].exercises.forEach(ex => {
              total++;
              if(State.app.completed[ex.id]) done++;
            });
          }
        });
        
        const pct = total === 0 ? 0 : Math.round((done/total)*100);

        const div = document.createElement('div');
        div.innerHTML = `
          <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-8 mb-6 shadow-xl border border-slate-100 dark:border-slate-800 text-center relative overflow-hidden group transition-theme">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500"></div>
            <div class="relative z-10">
              <div class="text-7xl font-black text-slate-800 dark:text-white mb-2 tracking-tighter bg-clip-text text-transparent bg-gradient-to-br from-slate-800 to-slate-500 dark:from-white dark:to-slate-400 transition-theme">${pct}%</div>
              <p class="text-slate-400 dark:text-slate-500 text-xs font-bold uppercase tracking-[0.2em] mb-8">Conclus√£o Semanal</p>
              <div class="inline-flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-900 rounded-full text-sm font-semibold text-slate-600 dark:text-slate-300 transition-theme">
                <span>üî•</span> ${done} / ${total} Exerc√≠cios
              </div>
            </div>
          </div>
          <button id="btn-reset-week" class="w-full bg-red-50 hover:bg-red-100 dark:bg-red-900/10 dark:hover:bg-red-900/20 text-red-500 dark:text-red-400 font-bold py-4 rounded-2xl transition-all text-sm flex items-center justify-center gap-3 border border-red-100 dark:border-red-900/30">
            <span>üóëÔ∏è</span> Reiniciar Semana
          </button>
        `;
        
        container.appendChild(div);
        
        document.getElementById('btn-reset-week').addEventListener('click', () => {
          this.showModal("Reiniciar Semana?", "Todo o hist√≥rico de check-ins ser√° apagado.", () => {
            State.app.completed = {};
            State.saveApp();
            this.renderAll();
            this.showToast("Semana reiniciada!");
          });
        });
      },

      renderChart() {
        const ctx = DOM['chart-semana']?.getContext('2d');
        if(!ctx) return;

        const labels = State.daysKeys;
        const dataPoints = labels.map(d => State.workout[d].exercises ? State.workout[d].exercises.filter(e => State.app.completed[e.id]).length : 0);
        const shortLabels = labels.map(l => l.substring(0,3));

        const isDark = State.app.theme === 'dark';
        const colors = isDark ? CONFIG.THEME_COLORS.dark : CONFIG.THEME_COLORS.light;
        
        if(State.chartInstance) State.chartInstance.destroy();

        State.chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: shortLabels,
            datasets: [{
              data: dataPoints,
              backgroundColor: colors.bar,
              borderRadius: 8,
              barThickness: 20,
              maxBarThickness: 32
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { enabled: false } },
            scales: {
              y: { beginAtZero: true, grid: { color: colors.grid, drawBorder: false }, ticks: { color: colors.text, font: {family: 'Inter', size: 10}, stepSize: 1 } },
              x: { grid: { display: false }, ticks: { color: colors.text, font: {family: 'Inter', size: 11, weight: '600'} } }
            }
          }
        });
        
        const doneTotal = dataPoints.reduce((a,b)=>a+b,0);
        DOM['info-metricas'].innerHTML = doneTotal > 0 
          ? `üî• <b>${doneTotal}</b> exerc√≠cios conclu√≠dos esta semana`
          : "Seus dados aparecer√£o aqui";
      }
    };

    /* =================================================================
       5. MANIPULA√á√ÉO DE EVENTOS (HANDLERS)
    ================================================================= */
    
    /* 5.1 Inicializa√ß√£o de Listeners */
    function initEvents() {
      // Configs
      DOM['btn-settings'].addEventListener('click', () => UI.toggleSettings());
      DOM['btn-close-settings'].addEventListener('click', () => UI.toggleSettings(true));
      DOM['btn-save-name-settings'].addEventListener('click', () => {
        const name = DOM['edit-user-name'].value.trim();
        if(name) { State.app.userName = name; State.saveApp(); UI.toggleSettings(); UI.renderAll(); UI.showToast("Nome salvo!"); }
      });
      DOM['btn-toggle-theme'].addEventListener('click', () => {
        State.app.theme = State.app.theme === 'light' ? 'dark' : 'light';
        State.saveApp();
        UI.renderAll();
      });

      // JSON Manual Toggle
      DOM['btn-toggle-json-area'].addEventListener('click', () => {
        const area = DOM['json-area-container'];
        area.classList.toggle('hidden');
      });

      DOM['btn-import-json'].addEventListener('click', () => {
        const input = DOM['json-input'].value;
        try {
          const parsed = JSON.parse(input);
          if(!Utils.validateWorkoutJSON(parsed)) throw new Error("Estrutura inv√°lida");
          State.workout = parsed;
          State.saveWorkout();
          State.init();
          UI.toggleSettings();
          UI.renderAll();
          UI.showToast("Treino importado com sucesso!");
        } catch(e) {
          UI.showToast("Erro: JSON inv√°lido.", "error");
        }
      });

      DOM['btn-reset-default'].addEventListener('click', () => {
        UI.showModal("Restaurar Padr√£o?", "Isso ir√° carregar o treino padr√£o.", () => {
          State.workout = DEFAULT_WORKOUT_JSON;
          State.saveWorkout();
          State.init();
          UI.toggleSettings();
          UI.renderAll();
          UI.showToast("Padr√£o restaurado!");
        });
      });

      // AI Events
      DOM['btn-open-ai-modal'].addEventListener('click', UI.openAiModal);
      DOM['btn-close-ai'].addEventListener('click', () => DOM['ai-generator-modal'].classList.remove('show'));
      DOM['btn-generate-workout'].addEventListener('click', UI.handleGenerateWorkout);
      DOM['btn-close-tip'].addEventListener('click', () => DOM['ai-tip-modal'].classList.remove('show'));
      
      // User Modal
      DOM['btn-start-modal'].addEventListener('click', () => {
        const name = DOM['input-user-name-modal'].value.trim();
        if(name) {
          State.app.userName = name;
          State.saveApp();
          DOM['user-modal'].classList.remove('show');
          UI.renderAll();
        }
      });

      // Confirm Modal
      DOM['btn-modal-cancel'].addEventListener('click', UI.closeModal);
      DOM['btn-modal-confirm'].addEventListener('click', () => {
        if(State.pendingModalAction) State.pendingModalAction();
        UI.closeModal();
      });

      // Event Delegation
      DOM['app-content'].addEventListener('click', (e) => {
        const btnCheck = e.target.closest('.check-btn');
        if (btnCheck) {
          const id = btnCheck.dataset.id;
          State.toggleCheck(id);
          setTimeout(() => UI.renderAll(), 50);
        }

        const btnTip = e.target.closest('.btn-tip');
        if (btnTip) {
          UI.openTipModal(btnTip.dataset.name, btnTip);
        }
      });

      DOM['app-content'].addEventListener('change', (e) => {
        if (e.target.classList.contains('weight-input')) {
          State.updateWeight(e.target.dataset.id, e.target.value);
        }
      });
    }

    /* =================================================================
       6. INICIALIZA√á√ÉO DO SISTEMA (BOOTSTRAP)
    ================================================================= */
    window.onload = function() {
      cacheDOM();
      State.init();
      initEvents();
      if(!State.app.userName) DOM['user-modal'].classList.add('show');
      UI.renderAll();
    };

  </script>
</body>
</html>
